# Изменения стратегии: старая версия vs обновленная (FVG-логика)

## Новые настройки пользователя
- Добавлен отдельный блок настроек **FVG Trading Settings** с переключателями для торговли возвратов в FVG, инверсий и использования FVG в качестве Take Profit, а также фильтрами минимального размера разрыва, требованием закрытия внутри зоны, лимитом «возраста» зоны и переключателем меток. Это позволяет гибко включать/отключать новую логику без правок кода и контролировать качество сигналов.

## Расширение данных FVG
- Структура `FVG` теперь хранит бар создания, что дает возможность фильтровать только подтвержденные зоны и избегать повторной обработки текущей свечи.
- Для визуализации и контроля количества подписей добавлены массивы `fvg_fill_labels` и `ifvg_labels`, а лимит подписей вынесен в константу `FVG_MARKER_LIMIT`.

## Дополнительные хелперы
- Реализованы функции `f_fvg_mid`, `f_fvg_size_pct`, `f_get_opposite_fvg_target` и `f_register_fvg_marker`, которые рассчитывают центр/размер разрыва, ищут противоположный FVG для целей и рисуют метки входов.

## Торговля по возврату в FVG
- В блок обработки Institutional Candles добавлена проверка `needFvgProcessing`, объединяющая визуализацию и торговую логику.
- При возврате цены внутрь FVG стратегия формирует сигнал `FVG Fill`, рассчитывает стоп/тейки, учитывает фильтры HTF, VWAP, сессию и приоритеты TP.

## Inversion FVG (IFVG)
- Если цена пробивает зону и закрывается за ней, формируется сигнал разворота `Inversion FVG`. Вход сопровождается расчетом стопа, выбором TP (включая приоритет противоположного FVG) и визуальной меткой `IFVG`.

## FVG как источник Take Profit
- При активной опции FVG-целей функция `f_get_opposite_fvg_target` подставляет ближайший противоположный разрыв в качестве основного либо первого TP в зависимости от режима.

## Обслуживание зон
- При инициализации новых FVG сохраняется индекс бара, а при удалении зон очищаются связанные боксы и массив. Дополнительно зона снимается только после подтвержденного заполнения (или инверсии), либо по истечении заданного лимита баров. Это предотвращает накапливание устаревших объектов и исключает случайные удаления при одиночных «хвостах».

Эти изменения интегрируют FVG в основную торговую логику, добавляют инверсионные сценарии и позволяют использовать противоположные зоны в качестве целей, что расширяет функциональность по сравнению с предыдущей версией, где FVG использовались только для визуализации.

## Новая волна оптимизаций SMC
- **ATR Adaptive Engine**: добавлен отдельный блок настроек, вычисляющий отношение текущего ATR к сглаженному и фильтрующий сигналы, а также подстраивающий кулдаун и R/R под волатильность.
- **Session Volume Guard**: стратегия теперь сравнивает текущий объём с усреднённым по активной сессии, отбрасывая сделки при отсутствии ликвидности.
- **Confluence Scoring**: фильтры VWAP, тренда, объёма, сессии и ATR складываются в общий балл, который должен превысить настраиваемый порог перед входом.
- **Dynamic Risk/Reward**: тейк-профиты рассчитываются через новую функцию `f_get_dynamic_rr`, учитывающую ATR, режим рынка и положение цены относительно VWAP.
- **Adaptive Cooldown**: базовый кулдаун сигналов масштабируется от волатильности, объёма и трендового состояния, благодаря чему стратегия чаще торгует в лучших условиях и реже — в шуме.
